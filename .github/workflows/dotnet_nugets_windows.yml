name: Build Nuget - (Windows)

on:
  workflow_dispatch:

jobs:
  build_nuget_windows:
    runs-on: windows-latest
    steps:
      - name: ğŸ§¬ Clonando repositÃ³rio simbiÃ³tico
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: âš™ï¸ Iniciando ambiente MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: ğŸ› ï¸ Instalando dotnet-t4
        run: |
          dotnet tool install --global dotnet-t4 || echo "âš ï¸ Falha ao instalar dotnet-t4, prosseguindo..."

      - name: ğŸ”„ Atualizando tags do Git
        run: |
          git fetch --unshallow --tags --recurse-submodules=no || echo "âš ï¸ NÃ£o foi possÃ­vel atualizar todas as tags"

      - name: ğŸ§  Coletando versÃ£o simbiÃ³tica
        id: get_version
        shell: bash
        run: |
          set -eo pipefail
          version=$(./utl/version_number.py || echo "0.0.0-simbiotico")
          version_trimmed=$(echo $version | sed 's/\+.*//')
          echo "ğŸ“¦ VersÃ£o gerada: $version"
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "version_trimmed=$version_trimmed" >> $GITHUB_OUTPUT

      - name: ğŸ§± Configurando build simbiÃ³tico .NET Core
        run: |
          cmake -S . -B build -G Ninja `
            -Dvw_BUILD_NET_CORE=On `
            -Dvw_DOTNET_USE_MSPROJECT=Off `
            -DVW_NUGET_PACKAGE_NAME=VowpalWabbit `
            -DVW_NUGET_PACKAGE_VERSION="${{ steps.get_version.outputs.version }}" `
            -DVW_NUGET_PACKAGE_VERSION_TRIMMED="${{ steps.get_version.outputs.version_trimmed }}" `
            -DVW_FEAT_FLATBUFFERS=Off `
            -DRAPIDJSON_SYS_DEP=Off `
            -DFMT_SYS_DEP=Off `
            -DSPDLOG_SYS_DEP=Off `
            -DVW_ZLIB_SYS_DEP=Off `
            -DVW_BOOST_MATH_SYS_DEP=Off `
            -DVW_BUILD_VW_C_WRAPPER=Off `
            -DBUILD_TESTING=Off `
            -DBUILD_SHARED_LIBS=Off || echo "âŒ Falha na configuraÃ§Ã£o do build"

      - name: ğŸ§ª Compilando .NET Core
        run: cmake --build build --config Release || echo "âŒ Falha ao compilar"

      - name: ğŸ“¦ Instalando build simbiÃ³tico
        run: cmake --install build --prefix ./nuget_staging || echo "âš ï¸ InstalaÃ§Ã£o falhou, verifique permissÃµes"

      - name: ğŸ§¾ Empacotando Nuget
        id: generate-nuget
        shell: powershell
        run: |
          try {
            cd nuget_staging
            nuget pack dotnet.nuspec
            $NugetFileName = Get-ChildItem *.nupkg -name
            echo "NugetFileName=$NugetFileName" >> $env:GITHUB_OUTPUT
            echo "ğŸ“¦ Pacote gerado com sucesso: $NugetFileName"
          } catch {
            Write-Host "âŒ Erro ao empacotar Nuget"
            exit 1
          }

      - name: â˜ï¸ Enviando artefato para o GitHub
        uses: actions/upload-artifact@v4
        with:
          name: VowpalWabbit.${{ steps.get_version.outputs.version }}.nupkg
          path: nuget_staging/${{ steps.generate-nuget.outputs.NugetFileName }}
